<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATIA Monitor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 추가적인 커스텀 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            font-family: 'Pretendard', sans-serif;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-Running { /* ★★★ 클래스명 일관성 유지 ★★★ */
            background-color: #22c55e; /* green-500 */
            animation: pulse 2s infinite;
        }

        .status-Offline {
            background-color: #ef4444; /* red-500 */
        }

        .status-Unreachable {
            background-color: #6b7280; /* gray-500 */
        }

        .status-Connecting\.\.\. { /* ★★★ Connecting... 상태 스타일 추가 ★★★ */
            background-color: #3b82f6; /* blue-500 */
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">CATIA Monitor Dashboard</h1>
            <p class="text-gray-600">클라이언트 PC의 카티아 실행 상태를 실시간으로 확인합니다.</p>
        </header>

        <main>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-sm font-semibold text-gray-600 tracking-wider">상태</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 tracking-wider">IP 주소</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 tracking-wider">최종 활동 시간</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 tracking-wider">마지막 로그 시간</th>
                                <th class="p-4 text-sm font-semibold text-gray-600 tracking-wider">작업</th>
                            </tr>
                        </thead>
                        <tbody id="status-table-body" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
            <footer class="text-center mt-6 text-sm text-gray-500">
                <p>5초마다 자동으로 갱신됩니다. 마지막 업데이트: <span id="last-updated" class="font-semibold">N/A</span></p>
            </footer>
        </main>
    </div>

    <script>
        const tableBody = document.getElementById('status-table-body');
        const lastUpdatedSpan = document.getElementById('last-updated');

        function formatDateTime(utcString) {
            if (utcString === 'N/A' || !utcString) return 'N/A';
            try {
                const date = new Date(utcString);
                if (isNaN(date.getTime())) return utcString;
                return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            } catch (e) {
                return utcString;
            }
        }

        // ★★★ 'CATIA 종료' 버튼 클릭 시 호출될 함수 추가 ★★★
        async function shutdownCatia(clientId, clientIp) {
            if (!confirm(`클라이언트 [${clientIp}]의 CATIA 프로그램을 정말로 종료하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId: clientId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('종료 명령을 성공적으로 전송했습니다.');
                } else {
                    alert('명령 전송에 실패했습니다: ' + data.message);
                }
                // 잠시 후 상태를 다시 로드하여 결과를 확인
                setTimeout(fetchAndUpdateStatus, 1500);
            } catch (error) {
                console.error('Shutdown API call failed:', error);
                alert('API 호출 중 오류가 발생했습니다.');
            }
        }

        async function fetchAndUpdateStatus() {
            const apiUrl = `${window.location.protocol}//${window.location.host}/api/status`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                // 서버에서 camelCase로 보내주므로 JavaScript에서도 camelCase로 받습니다.
                const clients = await response.json();
                tableBody.innerHTML = '';

                if (clients.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">연결된 클라이언트가 없습니다.</td></tr>`;
                } else {
                    clients.forEach(client => {
                        const row = document.createElement('tr');

                        // 서버에서 보내주는 Status 값에 따라 클래스와 텍스트를 결정합니다.
                        const statusText = client.status === 'Running' ? '실행 중' :
                            client.status === 'Offline' ? '오프라인' :
                                client.status === 'Unreachable' ? '연결 끊김' : '연결 중...';

                        // ★★★ 종료 버튼이 추가된 행 템플릿 ★★★
                        row.innerHTML = `
                                <td class="p-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="status-dot status-${client.status}"></span>
                                        <span class="font-medium text-gray-900">${statusText}</span>
                                    </div>
                                </td>
                                <td class="p-4 whitespace-nowrap text-gray-800 font-mono">${client.ipAddress}</td>
                                <td class="p-4 whitespace-nowrap text-gray-600 font-mono">${formatDateTime(client.lastSeen)}</td>
                                <td class="p-4 whitespace-nowrap text-gray-600 font-mono">${formatDateTime(client.lastLogTime)}</td>
                                <td class="p-4 whitespace-nowrap">
                                    <button onclick="shutdownCatia(${client.clientId}, '${client.ipAddress}')"
                                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200"
                                            title="CATIA 프로세스 강제 종료">
                                        CATIA 종료
                                    </button>
                                </td>
                            `;
                        tableBody.appendChild(row);
                    });
                }
                lastUpdatedSpan.textContent = new Date().toLocaleTimeString('ko-KR');

            } catch (error) {
                console.error("Failed to fetch status:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">데이터를 불러오는데 실패했습니다. 서버가 실행 중인지 확인하세요.</td></tr>`;
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAndUpdateStatus);
        setInterval(fetchAndUpdateStatus, 5000);
    </script>
</body>
</html>